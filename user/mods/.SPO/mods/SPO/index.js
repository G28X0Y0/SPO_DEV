const itemsToModify = {
    "5732ee6a24597719ae0c0281": {
        "grid": [{"cellH": 1, "cellV": 1}, {"cellH": 1, "cellV": 1}, {"cellH": 1, "cellV": 1}], // waist pouch
    }, 
    "544a11ac4bdc2d470e8b456a": {
        "grid": [{"cellH": 1, "cellV": 1}, {"cellH": 1, "cellV": 2}, {"cellH": 1, "cellV": 2}, {"cellH": 1, "cellV": 1}], // alpha
    }, 
    "5857a8b324597729ab0a0e7d": {
        "grid": [{"cellH": 1, "cellV": 2}, {"cellH": 2, "cellV": 2}, {"cellH": 1, "cellV": 2}], // beta
    }, 
    "5857a8bc2459772bad15db29": {
        "grid": [{"cellH": 1, "cellV": 3}, {"cellH": 2, "cellV": 2}, {"cellH": 1, "cellV": 3}], // gamma
    },
    "59db794186f77448bc595262": {
        "grid": [{"cellH": 2, "cellV": 3}, {"cellH": 2, "cellV": 2}], // epsilon
    }, 
    "5c093ca986f7740a1867ab12": {
        "grid": [{"cellH": 3, "cellV": 3}, {"cellH": 2, "cellV": 2}], // kappa
    }, 
    "5ab8f04f86f774585f4237d8": {
        "grid": [{"cellH": 3, "cellV": 3}, {"cellH": 2, "cellV": 3}], // sling
    }, 
    "5ab8ee7786f7742d8f33f0b9": {
        "grid": [{"cellH": 6, "cellV": 2}],  // vkbo
    }, 
    "56e33680d2720be2748b4576": {
        "grid": [{"cellH": 1, "cellV": 3}, {"cellH": 3, "cellV": 3}, {"cellH": 1, "cellV": 3}], // transformer bag
    }, 
    "5f5e45cc5021ce62144be7aa": {
        "grid": [{"cellH": 3, "cellV": 6}], // LK 3F
    }, 
    "56e33634d2720bd8058b456b": {
        "grid": [{"cellH": 4, "cellV": 4}, {"cellH": 1, "cellV": 4}], // Duffle bag
    }, 
    "5e997f0b86f7741ac73993e2": {
        "grid": [{"cellH": 4, "cellV": 5}, {"cellH": 1, "cellV": 5}], // Sanitar's bag	
    }, 
    "544a5cde4bdc2d39388b456b": {
        "grid": [{"cellH": 3, "cellV": 5}, {"cellH": 2, "cellV": 2}, {"cellH": 2, "cellV": 2}], // mbss
    }, 
    "56e335e4d2720b6c058b456d": {
        "grid": [{"cellH": 1, "cellV": 5}, {"cellH": 4, "cellV": 6}, {"cellH": 1, "cellV": 5}], // Scav backpack
    }, 
    "5e9dcf5986f7746c417435b3": {
        "grid": [{"cellH": 1, "cellV": 3}, {"cellH": 3, "cellV": 6}, {"cellH": 1, "cellV": 3}], // LBT-8005A
    }, 
    "5ca20d5986f774331e7c9602": {
        "grid": [{"cellH": 1, "cellV": 3}, {"cellH": 3, "cellV": 6}, {"cellH": 1, "cellV": 3}], // Berkut BB-102
    }, 
    "60a2828e8689911a226117f9": {
        "grid": [{"cellH": 4, "cellV": 6}, {"cellH": 1, "cellV": 4}], // Hazard4 Pillbox
    }, 
    "6034d103ca006d2dca39b3f0": {
        "grid": [{"cellH": 2, "cellV": 8}, {"cellH": 2, "cellV": 5}, {"cellH": 2, "cellV": 5}], // Hazard 4 Takedown black
    }, 
    "6038d614d10cbf667352dd44": {
        "grid": [{"cellH": 2, "cellV": 8}, {"cellH": 2, "cellV": 5}, {"cellH": 2, "cellV": 5}],// Hazard 4 Takedown multi
    }, 
    "60a272cc93ef783291411d8e": {
        "grid": [{"cellH": 2, "cellV": 5}, {"cellH": 4, "cellV": 7}, {"cellH": 2, "cellV": 5}], // Hazard 4 Drawbridge
    }, 
    "618bb76513f5097c8d5aa2d5": {
        "grid": [{"cellH": 5, "cellV": 6}, {"cellH": 2, "cellV": 4}], // Gruppa
    }, 
    "619cf0335771dd3c390269ae": {
        "grid": [{"cellH": 5, "cellV": 6}, {"cellH": 2, "cellV": 4}], // Gruppa
    }, 
    "618cfae774bb2d036a049e7c": {
        "grid": [{"cellH": 4, "cellV": 5}, {"cellH": 4, "cellV": 5}], // LBT-1476A
    }, 
    "5f5e467b0bc58666c37e7821": {
        "grid": [{"cellH": 5, "cellV": 7}, {"cellH": 1, "cellV": 7}], // Eberlestock F5
    }, 
    "5b44c6ae86f7742d1627baea": {
        "grid": [{"cellH": 5, "cellV": 6},{"cellH": 3, "cellV": 3}], // ANA Tactical Beta 2
    }, 
    "545cdae64bdc2d39198b4568": {
        "grid": [{"cellH": 1, "cellV": 7}, {"cellH": 4, "cellV": 7}, {"cellH": 1, "cellV": 7}], // Camelbak Tri-Zip
    }, 
    "59e763f286f7742ee57895da": {
        "grid": [{"cellH": 5, "cellV": 10}], // Pilgrim
    },
    "61b9e1aaef9a1b5d6a79899a": {
        "grid": [{"cellH": 5, "cellV": 10}], // Santa
    }, 
    "5ab8ebf186f7742d8b372e80": {
        "grid": [{"cellH": 4, "cellV": 9}, {"cellH": 2, "cellV": 5}, {"cellH": 2, "cellV": 5}], // SSO Attack 2
    }, 
    "5c0e774286f77468413cc5b2": {
        "grid": [{"cellH": 4, "cellV": 9}, {"cellH": 3, "cellV": 4}, {"cellH": 3, "cellV": 4}], // Mystery Ranch
    }, 
    "5df8a4d786f77412672a1e3b": {
        "grid": [{"cellH": 5, "cellV": 9}, {"cellH": 2, "cellV": 5}, {"cellH": 2, "cellV": 5}], // 6Sh118
    },
    "557ffd194bdc2d28148b457f": {
        "grid": [{"cellH": 1, "cellV": 1}, {"cellH": 1, "cellV": 2}, {"cellH": 1, "cellV": 2}, {"cellH": 1, "cellV": 1}], // pockets
    },
};

const items = DatabaseServer.tables.templates.items;
const handbook = DatabaseServer.tables.templates.handbook;
const prices = DatabaseServer.tables.templates.prices; 
const filters = ["54009119af1c881c07000029",];
const globals = DatabaseServer.tables.globals;
const KNIFE_ID = "5447e1d04bdc2dff2f8b4567";

const DB = DatabaseServer.tables;
const itemDB = DB.templates.items;
const globalDB = DB.globals.config;
const interiaDB = globalDB.Inertia;
//const DBlootCont = DB.loot.staticContainers;
const resKeys = ["5780cf7f2459777de4559322", "5ede7a8229445733cb4c18e2", "5efde6b4f5448336730dbd61", "5c94bbff86f7747ee735c08f", "5d80c60f86f77440373c4ece", "5d80c62a86f7744036212b3f", "5d08d21286f774736e7c94c3", "5e42c83786f7742a021fdf3c", "5e42c81886f7742a01529f57",  ]
for (const id in items){
      
    if(items[id]._parent == "543be5e94bdc2df1348b4568" || items[id]._parent == "5c99f98d86f7745c314214b3" || items[id]._parent == "5c164d2286f774194c5e69fa")
    {
      if (!resKeys.includes(items[id]._id))
        {
          items[id]._props.MaximumNumberOfUsage = 0;
        }
    }
}


//Increase base stamina
globalDB.Stamina.Capacity = 150;

//Reduce aim drain
globalDB.Stamina.AimDrainRate *= 0.28;
globalDB.Stamina.AimConsumptionByPose["y"] = 0.95;

//increase aim movement speed
globalDB.Stamina.AimingSpeedMultiplier = 0.75;

//Increase stam regen rate
globalDB.Stamina.BaseRestorationRate *= 3;

//Decrease sprint speed and limits
globalDB.SprintSpeed["x"] *= 0.6;
globalDB.SprintSpeed["y"] *= 0.6;

//Speed weight limits
globalDB.Stamina.WalkOverweightLimits["x"] = 42;
globalDB.Stamina.WalkOverweightLimits["y"] = 75;

globalDB.Stamina.BaseOverweightLimits["x"] = 26;
globalDB.Stamina.BaseOverweightLimits["y"] = 70;

globalDB.Stamina.SprintOverweightLimits["x"] = 26;
globalDB.Stamina.SprintOverweightLimits["y"] = 65;

globalDB.Stamina.WalkSpeedOverweightLimits["x"] = 32;
globalDB.Stamina.WalkSpeedOverweightLimits["y"] = 92;

//Adjust inertia
interiaDB.SideTime["x"] *= 0.4;
interiaDB.SideTime["y"] *= 0.4;
interiaDB.MinDirectionBlendTime *= 0.7;
interiaDB.WalkInertia["x"] *= 0.8;
interiaDB.WalkInertia["y"] *= 0.8;
interiaDB.TiltInertiaMaxSpeed["x"] *= 1.05;
interiaDB.TiltInertiaMaxSpeed["y"] *= 1.05;
interiaDB.TiltMaxSideBackSpeed["x"] *= 1.05;
interiaDB.TiltMaxSideBackSpeed["y"] *= 1.05;
interiaDB.TiltStartSideBackSpeed["x"] *= 1.05;
interiaDB.TiltStartSideBackSpeed["y"] *= 1.05;

//Recoil changes 
    for (let i in itemDB) {
        let fileData = itemDB[i];
        if (fileData._props.weapClass === "smg"
               || fileData._props.weapClass === "shotgun"
               || fileData._props.weapClass === "assaultCarbine"
               || fileData._props.weapClass === "sniperRifle"
               || fileData._props.weapClass === "assaultRifle"
               || fileData._props.weapClass === "machinegun"
               || fileData._props.weapClass === "marksmanRifle"
               || fileData._props.weapClass === "assaultRifle"
           ) {
               fileData._props.CameraRecoil *= 1.2;
               fileData._props.CameraSnap = 3.5;
           }
           if (fileData._props.weapClass === "pistol"
           ) {
               fileData._props.CameraRecoil *= 0.25;
               fileData._props.CameraSnap = 3.5;
           }
       }
        globalDB.Aiming.RecoilCrank = true;
        globalDB.Aiming.AimProceduralIntensity = 0.7;
        globalDB.Aiming.RecoilHandDamping = 0.6;
        globalDB.Aiming.RecoilDamping = 0.5;
        globalDB.Aiming.RecoilConvergenceMult *= 5;
        globalDB.Aiming.RecoilVertBonus = 100;
        globalDB.Aiming.RecoilBackBonus = 80;



//Lower sell value on melee weapons
handbook.Items.forEach(handbookItem => {
    const id = handbookItem.Id;

    if (items[id] && items[id]._parent === KNIFE_ID) {
        // divide the price by 10
        handbookItem.Price *= 0.1

        // limit the price to 15k
        handbookItem.Price = Math.min(21432, handbookItem.Price)
    }
})
for (const id in items){
    if (items[id]._parent == KNIFE_ID){
    items[id]._props.knifeHitSlashDam *= 3 
    items[id]._props.knifeHitStabDam *= 3 
    }
    }
//add protection to ears
Object.values(items)
.filter((item) => item._props.headSegments)
.map((item) => {
    if(item._props.headSegments.includes("Eyes") || item._props.headSegments.includes("Jaws")) {
        item._props.headSegments.push("Ears");
    }
});
//hyd / ene drain values
globals.config.Health.Effects.Existence = {
    // how much time between every tick of Energy consumption(i belive seconds)
    "EnergyLoopTime": 145,
    // how much time between every tick of Hydration consumption
    "HydrationLoopTime": 145,
    // Energy consomption amount every tick
    "EnergyDamage": 1,
    // Hydration consomption amount every tick
    "HydrationDamage": 3,
    // Multipliers when stomach blackout
    "DestroyedStomachEnergyTimeFactor": 2,
    "DestroyedStomachHydrationTimeFactor": 2
}
// globals.config.Stamina.SprintDrainRate = 4.5,
// globals.config.Stamina.BaseRestorationRate = 12

//disable selling to Flea
for (let i in items)
  {
    if (items[i]._props.CanSellOnRagfair)
    {
      items[i]._props.CanSellOnRagfair = false
    }
  }

// Removal of Run Through 
globals.config.exp.match_end.survived_exp_requirement= 0;
globals.config.exp.match_end.survived_seconds_requirement= 15;

//damage over blacked limbs to player
globals.config.Health.ProfileHealthSettings.BodyPartsSettings.LeftArm.OverDamageReceivedMultiplier= 0.25;
globals.config.Health.ProfileHealthSettings.BodyPartsSettings.RightArm.OverDamageReceivedMultiplier= 0.25;
globals.config.Health.ProfileHealthSettings.BodyPartsSettings.LeftLeg.OverDamageReceivedMultiplier= 0.25;
globals.config.Health.ProfileHealthSettings.BodyPartsSettings.RightLeg.OverDamageReceivedMultiplier= 0.25;
globals.config.Health.ProfileHealthSettings.BodyPartsSettings.Stomach.OverDamageReceivedMultiplier= 0.75;

//bleed changes 
globals.config.Health.Effects.HeavyBleeding = {
    "DefaultDelay": 0.4,
    "DefaultResidueTime": 0.4,
    "DamageEnergy": 0.5,
    "DamageHealth": 0.8,
    "EnergyLoopTime": 15,
    "HealthLoopTime": 2,
    "DamageHealthDehydrated": 0.4,
    "HealthLoopTimeDehydrated": 6,
}
globals.config.Health.Effects.LightBleeding = {
    "DefaultDelay": 0.4,
    "DefaultResidueTime": 0.4,
    "DamageEnergy": 0.5,
    "DamageHealth": 0.3,
    "EnergyLoopTime": 15,
    "HealthLoopTime": 2,
    "DamageHealthDehydrated": 0.4,
    "HealthLoopTimeDehydrated": 6,
}





class NewMod {
    
    

    static init() {
        // Loop over the items to modify
        for (const id in itemsToModify) {
            const excludeFilters = [];
            const grids = items[id]._props.Grids;

            for (const grid of grids) {
                let exf = [];
                if (grid._props.filters[0]) exf = grid._props.filters[0].ExcludedFilter; 
                excludeFilters.push(...exf,);
            }
            
            // overwrite the grid of the item with the new one
            items[id]._props.Grids = NewMod.createGrid(id, itemsToModify[id].grid, filters, excludeFilters);
        }
    }

    static createGrid(itemId, columns, filters, excludeFilters) {
        const grids = [];
        
        for (const [key, val] of Object.entries(columns)) {
            grids.push(NewMod.generateColumn(itemId, `column_${key}`, filters, excludeFilters, val.cellH, val.cellV));
        }

        return grids;
    }

    static generateColumn(itemId, name, filters, excludeFilters,  cellH, cellV) {
        return {
            "_name": name,
            "_id": HashUtil.generate(),
            "_parent": itemId,
            "_props": {
                "filters": [
                    {
                        "Filter": filters,
                        "ExcludedFilter": excludeFilters
                    }
                ],
                "cellsH": cellH,
                "cellsV": cellV,
                "minCount": 0,
                "maxCount": 0,
                "maxWeight": 0,
                "isSortingTable": false
            },
            "_proto": "55d329c24bdc2d892f8b4567"
        };
    };
}

ModLoader.onLoad['SPO'] = NewMod.init;
